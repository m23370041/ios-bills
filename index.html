<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>è¨˜å¸³å°å·¥å…·ï½œç®¡ç†è²»ãƒ»æ°´ãƒ»é›»ãƒ»ç“¦æ–¯</title>
  
  <!-- iOS åŠ åˆ°ä¸»ç•«é¢ï¼ˆå…¨è¢å¹•ï¼‰ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- Tailwindï¼ˆCDN ç‰ˆï¼Œå–®æª”å¥½ä¸Šæ‰‹ï¼‰ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .safe-top{ padding-top: max(1rem, env(safe-area-inset-top)); }
    .safe-bottom{ padding-bottom: max(1rem, env(safe-area-inset-bottom)); }
    @media (prefers-color-scheme: dark){ html{ color-scheme: dark; } body{ background:#0b0b0b; color:#e5e7eb; } }
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button{ -webkit-appearance: none; margin:0; }
  </style>
</head>
<body class="bg-gray-50 dark:bg-black text-gray-900 dark:text-gray-100">
  <header class="safe-top sticky top-0 z-50 bg-white/80 dark:bg-black/60 backdrop-blur border-b border-gray-200/70 dark:border-gray-800">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-lg font-semibold">è¨˜å¸³å°å·¥å…·ï½œç®¡ç†è²»ãƒ»æ°´ãƒ»é›»ãƒ»ç“¦æ–¯</h1>
      <button id="installHintBtn" class="text-xs px-2 py-1 rounded bg-gray-900 text-white dark:bg-white dark:text-black">åŠ å…¥ä¸»ç•«é¢</button>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 py-4 space-y-4">
    <!-- å®‰è£æç¤º -->
    <div id="installHint" class="hidden border border-amber-300 bg-amber-50 text-amber-900 dark:bg-amber-950/50 dark:text-amber-200 dark:border-amber-800 rounded-xl p-4">
      <p class="text-sm leading-relaxed">
        åœ¨ iPhone çš„ <strong>Safari</strong> æ‰“é–‹æœ¬é ï¼Œé»å³ä¸‹è§’<strong>åˆ†äº«</strong>ï¼ˆæ–¹æ¡†ä¸Šç®­é ­ï¼‰â†’ å‘ä¸‹æ² â†’ <strong>åŠ å…¥ä¸»ç•«é¢</strong>ã€‚
        åŠ å…¥å¾Œï¼Œå¾ä¸»ç•«é¢é–‹å•Ÿæœƒæ˜¯å…¨è¢å¹• App é«”é©—ã€‚
      </p>
    </div>

    <!-- æ–°å¢è¡¨å–® -->
    <section class="bg-white dark:bg-zinc-900 rounded-2xl shadow p-4">
      <h2 class="font-medium mb-3">æ–°å¢ä¸€ç­†</h2>
      <form id="entryForm" class="grid grid-cols-2 md:grid-cols-6 gap-3">
        <div class="col-span-2 md:col-span-2">
          <label class="text-xs text-gray-500">æ—¥æœŸ</label>
          <input id="date" type="date" class="w-full border rounded-lg px-3 py-2 bg-white/50 dark:bg-zinc-800 border-gray-200 dark:border-zinc-700" required>
        </div>
        <div>
          <label class="text-xs text-gray-500">é …ç›®</label>
          <select id="category" class="w-full border rounded-lg px-3 py-2 bg-white/50 dark:bg-zinc-800 border-gray-200 dark:border-zinc-700" required>
            <option>ç®¡ç†è²»</option>
            <option>æ°´è²»</option>
            <option>é›»è²»</option>
            <option>ç“¦æ–¯è²»</option>
            <option>å…¶ä»–</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-gray-500">é‡‘é¡</label>
          <input id="amount" type="number" inputmode="decimal" min="0" step="1" placeholder="0" class="w-full border rounded-lg px-3 py-2 bg-white/50 dark:bg-zinc-800 border-gray-200 dark:border-zinc-700" required>
        </div>
        <div class="col-span-2 md:col-span-2">
          <label class="text-xs text-gray-500">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
          <input id="note" type="text" placeholder="ä¾‹ï¼šAæ£Ÿ 8æœˆç®¡ç†è²»" class="w-full border rounded-lg px-3 py-2 bg-white/50 dark:bg-zinc-800 border-gray-200 dark:border-zinc-700">
        </div>
        <div class="col-span-2 md:col-span-6 flex flex-wrap gap-2">
          <button class="px-4 py-2 rounded-xl bg-black text-white dark:bg-white dark:text-black" type="submit">å„²å­˜ï¼ˆå¯«å…¥ Google Sheetï¼‰</button>
          <button id="exportCsv" class="px-4 py-2 rounded-xl bg-emerald-600 text-white" type="button">åŒ¯å‡º CSV</button>
          <input id="csvFile" type="file" accept=".csv" class="hidden" />
          <button id="importCsv" class="px-4 py-2 rounded-xl bg-amber-500 text-white" type="button">åŒ¯å…¥ CSV</button>
          <button id="clearAll" class="px-4 py-2 rounded-xl bg-gray-200 dark:bg-zinc-800" type="button">æ¸…ç©ºæ‰€æœ‰</button>
          <span id="syncBadge" class="text-xs px-2 py-1 rounded hidden"></span>
        </div>
      </form>
    </section>

    <!-- ç¯©é¸èˆ‡å°è¨ˆ -->
    <section class="bg-white dark:bg-zinc-900 rounded-2xl shadow p-4 space-y-3">
      <div class="flex flex-col md:flex-row gap-3 md:items-end">
        <div>
          <label class="text-xs text-gray-500">èµ·å§‹æ—¥</label>
          <input id="fromDate" type="date" class="w-full border rounded-lg px-3 py-2 bg-white/50 dark:bg-zinc-800 border-gray-200 dark:border-zinc-700">
        </div>
        <div>
          <label class="text-xs text-gray-500">çµæŸæ—¥</label>
          <input id="toDate" type="date" class="w-full border rounded-lg px-3 py-2 bg-white/50 dark:bg-zinc-800 border-gray-200 dark:border-zinc-700">
        </div>
        <div class="flex gap-2">
          <button id="applyFilter" class="px-4 py-2 rounded-xl bg-blue-600 text-white" type="button">å¥—ç”¨ç¯©é¸</button>
          <button id="resetFilter" class="px-4 py-2 rounded-xl bg-gray-200 dark:bg-zinc-800" type="button">é‡è¨­</button>
        </div>
      </div>

      <div id="summary" class="grid grid-cols-2 md:grid-cols-6 gap-2 text-sm"></div>
    </section>

    <!-- è³‡æ–™è¡¨ -->
    <section class="bg-white dark:bg-zinc-900 rounded-2xl shadow p-2">
      <div class="flex items-center justify-between px-2 py-2">
        <h2 class="font-medium">ç´€éŒ„</h2>
        <span id="count" class="text-xs text-gray-500"></span>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100 dark:bg-zinc-800">
            <tr>
              <th class="p-2 text-left">æ—¥æœŸ</th>
              <th class="p-2 text-left">é …ç›®</th>
              <th class="p-2 text-left">é‡‘é¡</th>
              <th class="p-2 text-left">å‚™è¨»</th>
              <th class="p-2 text-left">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="safe-bottom max-w-3xl mx-auto px-4 py-6 text-center text-xs text-gray-500">
    <p>æœ¬åœ°å„²å­˜ï¼ˆLocalStorageï¼‰ï½œæ›´æ›è£ç½®æˆ–æ¸…é™¤ç¶²ç«™è³‡æ–™æœƒæ¸…ç©ºæœ¬åœ°è³‡æ–™ã€‚è‹¥å·²é–‹å•Ÿ Google Sheets åŒæ­¥ï¼Œè©¦ç®—è¡¨å³ç‚ºä½ çš„é›²ç«¯å‚™ä»½ã€‚</p>
  </footer>

<script>
// =====================
//   ğŸ”§ è¨­å®šï¼ˆè«‹ä¿®æ”¹ï¼‰
// =====================
// 1) ä¾ç…§æˆ‘çµ¦ä½ çš„ Apps Script æ•™å­¸å»ºç«‹ Web Appï¼Œå°‡éƒ¨ç½²ç¶²å€è²¼åˆ°ä¸‹æ–¹ï¼š
const GOOGLE_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxcjlsY_395R6SZiGR4swIsz4wxflNCNfchZNX5yxDwpDQmg4_3E3BsArMFwjQX78Qk/exec';
// 2) èˆ‡ Apps Script ç«¯ä¸€è‡´çš„å¯†é‘°ï¼š
const SHARED_SECRET = '04241208';
// 3) è‹¥æš«æ™‚ä¸æƒ³åŒæ­¥ï¼Œè¨­ç‚º falseï¼š
const SYNC_ENABLED = true;

// =====================
//   åŸºç¤å·¥å…·
// =====================
const KEY = 'bills_entries_v2';
const CATS = ['ç®¡ç†è²»','æ°´è²»','é›»è²»','ç“¦æ–¯è²»','å…¶ä»–'];

function todayStr(){ const d = new Date(); return d.toISOString().slice(0,10); }
function uid(){ return (crypto?.randomUUID?.() || Math.random().toString(36).slice(2)) }
function load(){ try { return JSON.parse(localStorage.getItem(KEY)) || [] } catch { return [] } }
function save(list){ localStorage.setItem(KEY, JSON.stringify(list)) }
function between(dateStr, from, to){ if (from && dateStr < from) return false; if (to && dateStr > to) return false; return true }

function setSyncBadge(status, msg){
  const el = document.getElementById('syncBadge');
  el.classList.remove('hidden');
  el.textContent = msg || '';
  el.className = 'text-xs px-2 py-1 rounded ' + (
    status==='ok' ? 'bg-emerald-600 text-white' :
    status==='fail' ? 'bg-red-600 text-white' :
    'bg-gray-300 text-gray-800'
  );
}

// =====================
//   Sheets åŒæ­¥
// =====================
async function syncToSheet(rows){
  if (!SYNC_ENABLED) return { ok:true, disabled:true };
  if (!GOOGLE_WEBAPP_URL || GOOGLE_WEBAPP_URL.startsWith('PASTE_')){
    setSyncBadge('fail','æœªè¨­å®š Sheets åŒæ­¥');
    return { ok:false, error:'missing_webapp_url' };
  }
  try{
    setSyncBadge('','åŒæ­¥ä¸­â€¦');
    const res = await fetch(GOOGLE_WEBAPP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ secret: SHARED_SECRET, rows })
    });
    const j = await res.json();
    if(!j.ok) throw new Error(j.error || 'sync_failed');
    setSyncBadge('ok',`å·²åŒæ­¥ ${j.inserted ?? rows.length} ç­†`);
    setTimeout(()=>document.getElementById('syncBadge').classList.add('hidden'), 2000);
    return j;
  }catch(err){
    console.error('[Sheet Sync]', err);
    setSyncBadge('fail','åŒæ­¥å¤±æ•—ï¼ˆä»å·²å­˜æœ¬æ©Ÿï¼‰');
    return { ok:false, error: String(err) };
  }
}

// =====================
//   æ¸²æŸ“
// =====================
function renderTable(list, from=null, to=null){
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  let data = [...list].sort((a,b)=> a.date < b.date ? 1 : -1);
  if(from || to) data = data.filter(e => between(e.date, from, to));
  for(const e of data){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-2 whitespace-nowrap">${e.date}</td>
      <td class="p-2">${e.category}</td>
      <td class="p-2 text-right">${Number(e.amount).toLocaleString('zh-Hant-TW')}</td>
      <td class="p-2">${e.note || ''}</td>
      <td class="p-2"><button class="px-2 py-1 rounded bg-red-600 text-white" data-id="${e.id}">åˆªé™¤</button></td>
    `;
    tbody.appendChild(tr);
  }
  document.getElementById('count').textContent = `å…± ${data.length} ç­†`;
  tbody.querySelectorAll('button[data-id]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(!confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†ï¼Ÿ')) return;
      const all = load().filter(x => x.id !== btn.dataset.id);
      save(all); refresh();
    })
  })
}

function renderSummary(list, from=null, to=null){
  const box = document.getElementById('summary');
  const sum = { 'ç®¡ç†è²»':0, 'æ°´è²»':0, 'é›»è²»':0, 'ç“¦æ–¯è²»':0, 'å…¶ä»–':0, total:0 };
  for(const e of list){ if(!between(e.date,from,to)) continue; const n = Number(e.amount)||0; sum[e.category] = (sum[e.category]||0)+n; sum.total += n; }
  box.innerHTML = '';
  const fmt = n => n.toLocaleString('zh-Hant-TW');
  [...CATS, 'åˆè¨ˆ'].forEach(cat=>{
    const key = (cat==='åˆè¨ˆ')? 'total' : cat;
    const div = document.createElement('div');
    div.className = 'rounded-xl border border-gray-200 dark:border-zinc-700 px-3 py-2';
    div.innerHTML = `<div class="text-xs text-gray-500">${cat}</div><div class="text-lg font-semibold">$ ${fmt(sum[key]||0)}</div>`;
    box.appendChild(div);
  })
}

function refresh(){
  const all = load();
  const from = document.getElementById('fromDate').value || null;
  const to = document.getElementById('toDate').value || null;
  renderTable(all, from, to);
  renderSummary(all, from, to);
}

// =====================
//   äº‹ä»¶ç¶å®š
// =====================
document.getElementById('date').value = todayStr();

document.getElementById('entryForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const date = document.getElementById('date').value;
  const category = document.getElementById('category').value;
  const amount = document.getElementById('amount').value.trim();
  const note = document.getElementById('note').value.trim();

  if(!date) return alert('è«‹é¸æ“‡æ—¥æœŸ');
  const num = Number(amount);
  if(!amount || isNaN(num) || num < 0) return alert('é‡‘é¡éœ€ç‚ºæ•¸å­—');

  const entry = { id: uid(), date, category, amount: num, note, created_at: new Date().toISOString() };

  // å…ˆå¯«å…¥ Google Sheetï¼›è‹¥å¤±æ•—å‰‡ä¸å¯«å…¥æœ¬æ©Ÿ
  const cloud = await syncToSheet([{ ...entry, source:'ios-web' }]);
  if(!cloud.ok){
    alert('å¯«å…¥ Google Sheet å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼ˆå·²å–æ¶ˆæœ¬æ©Ÿå„²å­˜ï¼‰');
    return;
  }

  // é›²ç«¯æˆåŠŸå¾Œï¼Œå†å¯«å…¥æœ¬æ©Ÿä½œç‚ºå‚™ä»½
  const all = load(); all.push(entry); save(all);
  document.getElementById('amount').value = '';
  document.getElementById('note').value = '';
  refresh();
});
  const date = document.getElementById('date').value;
  const category = document.getElementById('category').value;
  const amount = document.getElementById('amount').value.trim();
  const note = document.getElementById('note').value.trim();

  if(!date) return alert('è«‹é¸æ“‡æ—¥æœŸ');
  const num = Number(amount);
  if(!amount || isNaN(num) || num < 0) return alert('é‡‘é¡éœ€ç‚ºæ•¸å­—');

  const entry = { id: uid(), date, category, amount: num, note, created_at: new Date().toISOString() };
  const all = load(); all.push(entry); save(all);
  await syncToSheet([{ ...entry, source:'ios-web' }]);
  document.getElementById('amount').value = '';
  document.getElementById('note').value = '';
  refresh();
});

document.getElementById('applyFilter').addEventListener('click', refresh);

document.getElementById('resetFilter').addEventListener('click', ()=>{
  document.getElementById('fromDate').value = '';
  document.getElementById('toDate').value = '';
  refresh();
});

document.getElementById('clearAll').addEventListener('click', ()=>{
  if(confirm('æ¸…ç©ºæ‰€æœ‰ç´€éŒ„ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸ')){ localStorage.removeItem(KEY); refresh(); }
});

document.getElementById('exportCsv').addEventListener('click', ()=>{
  const from = document.getElementById('fromDate').value || null;
  const to = document.getElementById('toDate').value || null;
  const data = load().filter(e => between(e.date, from, to));
  const headers = ['date','category','amount','note','created_at'];
  const rows = [headers.join(',')].concat(
    data.map(e => headers.map(h => {
      const v = (e[h] ?? '').toString().replaceAll('"','""');
      return '"'+v+'"';
    }).join(','))
  );
  const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'bills.csv'; a.click(); URL.revokeObjectURL(url);
});

// ====== CSV åŒ¯å…¥ï¼ˆå«åŒæ­¥ï¼‰ ======
const csvInput = document.getElementById('csvFile');
document.getElementById('importCsv').addEventListener('click',()=> csvInput.click());

function parseCSV(text){
  const rows = [];
  const lines = text.replace(/\r/g,'').split('\n').filter(Boolean);
  if(!lines.length) return rows;
  const split = (line)=>{
    const out=[]; let cur=''; let q=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c==='"'){
        if(q && line[i+1]==='"'){ cur+='"'; i++; } else { q=!q; }
      } else if(c===',' && !q){ out.push(cur); cur=''; }
      else { cur+=c; }
    }
    out.push(cur); return out;
  };
  const header = split(lines[0]).map(h=>h.trim().toLowerCase());
  const idx = {
    date: header.indexOf('date')>-1? header.indexOf('date') : header.indexOf('æ—¥æœŸ'),
    category: header.indexOf('category')>-1? header.indexOf('category') : header.indexOf('é …ç›®'),
    amount: header.indexOf('amount')>-1? header.indexOf('amount') : header.indexOf('é‡‘é¡'),
    note: header.indexOf('note')>-1? header.indexOf('note') : header.indexOf('å‚™è¨»')
  };
  for(let i=1;i<lines.length;i++){
    const cols = split(lines[i]);
    const date = (cols[idx.date]||'').trim();
    const category = (cols[idx.category]||'').trim() || 'å…¶ä»–';
    const amount = Number((cols[idx.amount]||'0').replace(/,/g,''));
    const note = (cols[idx.note]||'').trim();
    if(!date || isNaN(amount)) continue;
    rows.push({ id: uid(), date, category, amount, note, created_at: new Date().toISOString() });
  }
  return rows;
}

csvInput.addEventListener('change', async (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  const text = await file.text();
  const rows = parseCSV(text);
  if(!rows.length) return alert('æ²’æœ‰å¯åŒ¯å…¥çš„è³‡æ–™');
  const all = load(); all.push(...rows); save(all);
  // æ‰¹æ¬¡åŒæ­¥ï¼Œé¿å…è«‹æ±‚éå¤§
  const size = 200;
  for(let i=0;i<rows.length;i+=size){
    const batch = rows.slice(i,i+size).map(r=> ({...r, source:'import'}));
    await syncToSheet(batch);
  }
  alert(`å·²åŒ¯å…¥ ${rows.length} ç­†`);
  refresh();
});

// ====== iOS å®‰è£æç¤º ======
function shouldShowInstallHint(){
  const ua = navigator.userAgent.toLowerCase();
  const isIOS = /iphone|ipad|ipod/.test(ua);
  const isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
  return isIOS && !isStandalone;
}
const installHint = document.getElementById('installHint');
const installHintBtn = document.getElementById('installHintBtn');
if(shouldShowInstallHint()) installHint.classList.remove('hidden');
installHintBtn.addEventListener('click', ()=> installHint.classList.toggle('hidden'));

// é¦–æ¬¡æ¸²æŸ“
refresh();
</script>
</body>
</html>
